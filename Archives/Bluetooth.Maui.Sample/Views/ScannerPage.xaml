<?xml version="1.0" encoding="utf-8"?>

<views:BaseContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
                       xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
                       xmlns:vm="clr-namespace:Bluetooth.Maui.Sample.ViewModels"
                       xmlns:abstractions="clr-namespace:Bluetooth.Core.Abstractions;assembly=Bluetooth.Core"
                       xmlns:views="clr-namespace:Bluetooth.Maui.Sample.Views"
                       xmlns:scan="clr-namespace:Bluetooth.Core.Abstractions.Scan;assembly=Bluetooth.Core"
                       x:Class="Bluetooth.Maui.Sample.Views.ScannerPage"
                       x:DataType="vm:ScannerPageViewModel"
                       Title="Bluetooth Scanner">

    <Grid RowDefinitions="Auto,*,Auto"
          Padding="20">

        <!-- Header with scan controls -->
        <VerticalStackLayout Grid.Row="0"
                             Spacing="10"
                             Margin="0,0,0,20">
            <HorizontalStackLayout Spacing="10"
                                   HorizontalOptions="Center">
                <Button Text="Start Scan"
                        Command="{Binding OnStartScannerButtonClickedCommand}"
                        IsEnabled="{Binding IsScanning, Converter={StaticResource InvertedBoolConverter}}"
                        WidthRequest="120" />

                <Button Text="Stop Scan"
                        Command="{Binding OnStopScannerButtonClickedCommand}"
                        IsEnabled="{Binding IsScanning}"
                        WidthRequest="120" />
            </HorizontalStackLayout>

            <Label Text="{Binding IsScanning, StringFormat='Status: {0}'}"
                   HorizontalOptions="Center"
                   FontSize="14"
                   TextColor="Gray">
                <Label.Triggers>
                    <DataTrigger TargetType="Label"
                                 Binding="{Binding IsScanning}"
                                 Value="True">
                        <Setter Property="TextColor"
                                Value="Green" />
                        <Setter Property="Text"
                                Value="Status: Scanning..." />
                    </DataTrigger>
                    <DataTrigger TargetType="Label"
                                 Binding="{Binding IsScanning}"
                                 Value="False">
                        <Setter Property="TextColor"
                                Value="Gray" />
                        <Setter Property="Text"
                                Value="Status: Stopped" />
                    </DataTrigger>
                </Label.Triggers>
            </Label>
        </VerticalStackLayout>

        <!-- Device list -->
        <CollectionView Grid.Row="1"
                        ItemsSource="{Binding Devices}"
                        SelectedItem="{Binding SelectedDevice}"
                        SelectionMode="Single"
                        ItemSizingStrategy="MeasureFirstItem"
                        HorizontalScrollBarVisibility="Never"
                        HorizontalOptions="Fill">
            <CollectionView.ItemsLayout>
                <GridItemsLayout Orientation="Vertical" />
            </CollectionView.ItemsLayout>
            <CollectionView.EmptyView>
                <ContentView>
                    <VerticalStackLayout HorizontalOptions="Center"
                                         VerticalOptions="Center"
                                         Spacing="10">
                        <Label Text="No devices found"
                               FontSize="18"
                               TextColor="Gray"
                               HorizontalOptions="Center" />
                        <Label Text="Press 'Start Scan' to discover Bluetooth devices"
                               FontSize="14"
                               TextColor="Gray"
                               HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </ContentView>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="scan:IBluetoothDevice">
                    <Border Padding="15"
                            BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2C2C2C}"
                            Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#404040}">
                        <Grid ColumnDefinitions="*,Auto"
                              RowDefinitions="Auto,Auto,Auto,Auto,Auto"
                              ColumnSpacing="10">

                            <!-- Device Name -->
                            <Label Grid.Row="0"
                                   Grid.Column="0"
                                   Text="{Binding Name}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" />

                            <!-- No Device Name -->
                            <Label Grid.Row="0"
                                   Grid.Column="0"
                                   Text="NO NAME"
                                   IsVisible="{Binding Name, Converter={StaticResource IsStringNullOrEmptyConverter}}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" />

                            <!-- Signal Strength -->
                            <Label Grid.Row="0"
                                   Grid.Column="1"
                                   Text="{Binding SignalStrengthDbm, StringFormat='{0} dBm'}"
                                   FontSize="14"
                                   VerticalOptions="Center"
                                   TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}" />

                            <!-- Device ID -->
                            <Label Grid.Row="1"
                                   Grid.Column="0"
                                   Grid.ColumnSpan="2"
                                   Text="{Binding Id}"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}" />

                            <!-- Signal Strength Prc -->
                            <Label Grid.Row="1"
                                   Grid.Column="1"
                                   Text="{Binding SignalStrengthPercent, StringFormat='{0:P0}'}"
                                   FontSize="14"
                                   VerticalOptions="Center"
                                   TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}" />

                            <!-- Connection State -->
                            <Label Grid.Row="2"
                                   Grid.Column="0"
                                   Text="{Binding IsConnected, StringFormat='Connected: {0}'}"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}" />

                            <!-- Connection State -->
                            <Label Grid.Row="3"
                                   Grid.Column="0"
                                   Text="{Binding Manufacturer, StringFormat='By: {0}'}"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}" />

                            <ProgressBar Grid.Row="4"
                                         Grid.Column="0"
                                         Grid.ColumnSpan="2"
                                         Progress="{Binding SignalStrengthPercent}"
                                         HeightRequest="10"
                                         Margin="0,5,0,0"
                                         BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                                         ProgressColor="{AppThemeBinding Light=#3B82F6, Dark=#60A5FA}" />
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <Grid Grid.Row="2" ColumnDefinitions="*,Auto,*" >
            <!-- Device count footer -->
            <Label Text="{Binding Devices.Count, StringFormat='Devices found: {0}'}"
                   Grid.Column="1"
                   FontSize="14"
                   HorizontalOptions="Center"
                   Margin="0,20,0,0"
                   TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}" />

            <Button Text="⚙️"
                    Grid.Column="2"
                    HorizontalOptions="End"
                    Command="{Binding OnConfigScannerButtonClickedCommand}" />
        </Grid>
    </Grid>

</views:BaseContentPage>

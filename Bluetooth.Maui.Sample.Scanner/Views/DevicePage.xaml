<?xml version="1.0" encoding="utf-8" ?>
<base:BaseContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
                      xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
                      xmlns:base="clr-namespace:Bluetooth.Maui.Sample.Scanner.Infrastructure"
                      xmlns:vm="clr-namespace:Bluetooth.Maui.Sample.Scanner.ViewModels"
                      xmlns:scan="clr-namespace:Bluetooth.Abstractions.Scanning;assembly=Bluetooth.Abstractions.Scanning"
                      x:Class="Bluetooth.Maui.Sample.Scanner.Views.DevicePage"
                      x:TypeArguments="vm:DeviceViewModel"
                      x:DataType="vm:DeviceViewModel"
                      Title="Device Details">

    <Grid RowDefinitions="Auto,*" Padding="16">

        <!-- Device Info & Controls -->
        <VerticalStackLayout Grid.Row="0" Spacing="12">

            <!-- Device Name -->
            <Label Text="{Binding DeviceName}"
                   FontAttributes="Bold"
                   FontSize="24"
                   HorizontalOptions="Center" />

            <!-- Device ID -->
            <Label Text="{Binding DeviceId}"
                   FontSize="14"
                   TextColor="{StaticResource Gray600}"
                   HorizontalOptions="Center" />

            <!-- Connection Status -->
            <Label x:Name="ConnectionStatus"
                   FontAttributes="Bold"
                   FontSize="16"
                   HorizontalOptions="Center">
                <Label.Triggers>
                    <DataTrigger TargetType="Label" Binding="{Binding IsConnected}" Value="True">
                        <Setter Property="Text" Value="ðŸŸ¢ Connected" />
                        <Setter Property="TextColor" Value="{StaticResource ConnectedGreen}" />
                    </DataTrigger>
                    <DataTrigger TargetType="Label" Binding="{Binding IsConnected}" Value="False">
                        <Setter Property="Text" Value="ðŸ”´ Disconnected" />
                        <Setter Property="TextColor" Value="{StaticResource DisconnectedRed}" />
                    </DataTrigger>
                </Label.Triggers>
            </Label>

            <!-- Connection Controls -->
            <HorizontalStackLayout Spacing="12" HorizontalOptions="Center" Margin="0,8,0,0">
                <Button Text="Connect"
                        Command="{Binding ConnectCommand}"
                        WidthRequest="120" />
                <Button Text="Disconnect"
                        Command="{Binding DisconnectCommand}"
                        WidthRequest="120" />
            </HorizontalStackLayout>

            <!-- Explore Services Button -->
            <Button Text="Explore Services"
                    Command="{Binding ExploreServicesCommand}"
                    HorizontalOptions="Center"
                    WidthRequest="200"
                    Margin="0,8,0,0" />

            <!-- Service Count -->
            <Label Text="{Binding ServiceCount, StringFormat='{0} services discovered'}"
                   FontSize="14"
                   FontAttributes="Italic"
                   TextColor="{StaticResource Gray600}"
                   HorizontalOptions="Center"
                   IsVisible="{Binding ServiceCount, Converter={StaticResource IsNotZeroConverter}}" />

            <BoxView HeightRequest="1" Color="{StaticResource Gray200}" Margin="0,12" />
        </VerticalStackLayout>

        <!-- Services List -->
        <CollectionView Grid.Row="1"
                        ItemsSource="{Binding Services}"
                        SelectionMode="Single"
                        SelectionChangedCommand="{Binding SelectServiceCommand}"
                        SelectionChangedCommandParameter="{Binding Source={RelativeSource Self}, Path=SelectedItem}">

            <CollectionView.EmptyView>
                <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="12">
                    <Label Text="No services discovered"
                           FontSize="18"
                           TextColor="{StaticResource Gray500}"
                           HorizontalOptions="Center" />
                    <Label Text="Connect to the device and tap 'Explore Services' to discover GATT services"
                           FontSize="14"
                           TextColor="{StaticResource Gray500}"
                           HorizontalOptions="Center"
                           HorizontalTextAlignment="Center"
                           Margin="20,0" />
                </VerticalStackLayout>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="scan:IBluetoothRemoteService">
                    <Frame Padding="12" Margin="0,4" CornerRadius="8" HasShadow="True">
                        <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" ColumnSpacing="12">

                            <!-- Service Icon -->
                            <Label Grid.Row="0" Grid.Column="0" Grid.RowSpan="2"
                                   Text="ðŸ“¡"
                                   FontSize="32"
                                   VerticalOptions="Center" />

                            <!-- Service UUID -->
                            <Label Grid.Row="0" Grid.Column="1"
                                   Text="{Binding Id, StringFormat='Service: {0}'}"
                                   FontAttributes="Bold"
                                   FontSize="14"
                                   LineBreakMode="TailTruncation" />

                            <!-- Characteristics Count (placeholder for now) -->
                            <Label Grid.Row="1" Grid.Column="1"
                                   Text="Tap to explore characteristics"
                                   FontSize="12"
                                   TextColor="{StaticResource Gray600}" />

                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>

        </CollectionView>

    </Grid>

</base:BaseContentPage>
